## Core Characteristics

### Method Name

The method name that identifies this DID method SHALL be: `webs`.

> Note: when pronounced aloud, "webs" SHOULD become two syllables: the word
> "web" and the letter "s" (which stands for "secure"). Separating the final
> letter this way emphasizes that the method offers a security upgrade surpassing
> the one HTTPS gives to HTTP.

A DID that uses this method MUST begin with the following prefix: `did:webs:`.
Per the DID specification, this string MUST be lower case. The remainder of the
DID, after the prefix, is the case-sensitive [[ref: method-specific identifier]]
([[ref: MSI]]) described [below](#method-specific-identifier).

### Method-Specific Identifier

The `did:webs` [[ref: method-specific identifier]] has two
parts, a fully qualified domain name with an optional path (identical to
`did:web`), plus a KERI AID (autonomic identifier) that is always the final
component of the path.

The [[ref: ABNF]] definition of a `did:webs` DID is as follows:

```
webs-did = "did:webs:" domain-name ":" aid
webs-did = "did:webs:" domain-name * (":" path) ":" aid
```

::: todo
> TODO: what about intl chars? Does DID spec allow them like URL spec does? What
about localhost vs. 127.0.0.1 vs. ::1?
:::

The formal rules describing valid domain name syntax are described in
[RFC1035], [RFC1123], and [RFC2181]. The fully qualified domain MUST NOT
include IP addresses. A port MAY be included and the colon MUST be percent
encoded to prevent a conflict with paths. Directories and subdirectories MAY
optionally be included, delimited by colons rather than slashes.

A KERI AID is a unique identifier derived from the
inception event of a KERI identifier. The inception event is the first item in the identifier's [[ref: KEL]].
The algorithm used to generate the AID depends on
the type of AID. If the AID is transferable (supports key rotation) then the AID is generated by taking a cryptographic
digest of the inception event of the KEL of the AID. If the AID is non-transferable (does not support key rotation) the
AID is generated by taking a cryptographic digest of the first (and only) public key of the identifier. See the [[ref: KERI Fundamentals]] section for more details.

After the fully qualified domain name and optional path in a `did:webs` is a
final path component, a colon and the AID. To be compatible with `did:web`, the
AID is "just a path", the final (and perhaps only) path element. The presence of
the required AID as a path element means that a `did:webs` always has a path,
and so the "no path" version of a `did:web` that implicitly uses the
`.well-known` folder is not supported by `did:webs`. Any `did:webs` can be
expressed as a `did:web` but the inverse is not true--a `did:webs` MUST include
an AID.

### Target System(s)

As with `did:web`, this method reads data from whatever web server is referenced
when the domain name portion of one of its DIDs is resolved through the Domain
Name System (DNS). In fact, a `did:webs` can be resolved to a [[ref: DID document]]
using a simple text transformation to an HTTPS URL in the same way as a
`did:web`. By design, a `did:web` and `did:webs` with the same [[ref: method-specific identifier]] will return the same
DID document, except for minor differences in the `id`, `controller`, and `alsoKnownAs` top-level properties that pertain to the identifiers themselves.

However, this method introduces an important nuance about the target system. In
many DID methods, the target system equals a [[ref: verifiable data registry]] —
besides publishing data, its security attributes make that data trustworthy. In
this DID method, the target system's role is more limited. It is expected to
serve data about the DID, and to follow acknowledged cybersecurity best
practices to preserve good hygiene.

However, the authenticity of data is
guaranteed by the DID value itself, in conjunction with a digitally signed
data structure called a [[ref: KERI event stream]], which includes for a given AID its 
[[ref: key event log]] ([[ref: KEL]]) and [[ref: transaction event log]] ([[ref: TEL]]). These trust
mechanisms — the integrity checks built into the DID value, and the workings of
the [[ref: KERI event stream]] — are defined by [[ref: KERI]].

As with `did:web`, the location of the [[ref: DID document]] is determined by transforming the DID to an
HTTPS URL as follows:

- Replace `did:webs` with `https://`
- Replace the "`:`"s in the method-specific identifier with path separators, "'/'"s
- Convert the optional port percent encoding ("`%3A`"`) to a colon.
- Append "`/did.json`" to the resulting string.

A GET on that URL MUST return the DID document.

The location of the [[ref: KERI event stream]] is determined by transforming the previous URL as follows:

- Replace the trailing "`/did.json`" with "`/keri.cesr`".

A GET on that URL MUST return the [[ref: KERI event stream]] for the AID in the `did:webs` identifier.
The [[ref: KERI event stream]] MUST be CESR-formatted (media type of application/cesr) and the KERI events must be verifiable using the KERI rules.

The following are some example `did:webs` DIDs and their corresponding DID document and [[ref: KERI event stream]]
URLs, based on the examples from the [DID Web Specification](https://github.com/w3c-ccg/did-method-web/), but with the (faked) AID
`12124313423525` added:

- `did:webs:w3c-ccg.github.io:12124313423525`
  - DID document URL: https://w3c-ccg.github.io/12124313423525/did.json
  - [[ref: KERI event stream]] URL: https://w3c-ccg.github.io/12124313423525/keri.cesr
- `did:webs:w3c-ccg.github.io:user:alice:12124313423525`
  - DID document URL: https://w3c-ccg.github.io/user/alice/12124313423525/did.json
  - [[ref: KERI event stream]] URL: https://w3c-ccg.github.io/user/alice/12124313423525/keri.cesr
- `did:webs:example.com%3A3000:user:alice:12124313423525`
  - DID document URL: https://example.com:3000/user/alice/12124313423525/did.json
  - [[ref: KERI event stream]] URL: https://example.com:3000/user/alice/12124313423525/keri.cesr

The `did:web` version of the DIDs are the same (minus the `s`) and point
to the same `did.json` file, but have no knowledge of the `keri.cesr` file.

The set of KERI features needed
for most `did:webs` use cases is modest, with limited dependencies. These basics
are summarized in the [KERI Fundamentals](#keri-fundamentals) section of this
specification. This specification assumes a working knowledge of the concepts
there. The inclusion of KERI in `did:webs` enables a number of capabilities for
securing a `did:webs` identifier, including multi-signature support and the
creation of [[ref: pre-rotated]] keys to prevent loss of control of the identifier if the
current private key were to be compromised.

A target system cannot forge or tamper with data protected by KERI, and if it
deliberately serves an outdated copy, the duplicity is often detectable. Thus,
any given target system in isolation can be viewed by this method as a dumb,
untrusted server of content. It is the combination of target systems and some
KERI mechanisms, _together_, that constitutes this method's verifiable data
registry. In short, verifying the DID document by processing the [[ref: KERI event stream]] using KERI puts
the "s" of "security" in `did:webs`.

### AID controlled identifiers

Since an AID is a unique cryptographic identifier that is inseparably bound to the [[ref: KERI event stream]] from
which it is associated, any AIDs and any `did:webs` DIDs that have the same AID component
have the same controller(s). [[def: AID controlled identifiers]], including any `did:webs` DIDs that have the same AID,
are by definition referencing the same identity, although they may vary in how quickly they reflect the current identity information, DID document and [[ref: KERI event stream]].
Notably, as defined in section [Identifiers in a `did:webs` DID document](#identifiers-in-a-didwebs-did-document), the
`id` property in the DID document will differ based on the web location of the DID document. As
well, different versions of the DID document and [[ref: KERI event stream]] may reside in different locations
depending on the replication capabilities of the controlling entity. If the [[ref: KERI event streams]]
differ for `did:webs` DIDs with the same AID, the smaller [[ref: KERI event stream]] MUST be a prefix
of the larger [[ref: KERI event stream]] (e.g., the only difference in the [[ref: KERI event streams]] being the extra events in one
of the [[ref: KERI event streams]], not yet reflected in the other). If the [[ref: KERI event streams]] diverge from one other
(e.g., one is not a subset of the other), both the [[ref: KERI event streams]] and the DIDs MUST be
considered invalid.

The web supports a number of ways to redirect users. See the section on
[Handling Web Redirections](#handling-web-redirection) later in this specification.

KERI anticipates the possibility of a duplicitous actor with an AID that forks a
[[ref: KERI event stream]] and shares different versions of the [[ref: KERI event stream]] containing different events, such
as publishing different versions of the [[ref: KERI event stream]] on different web servers. The
verification of the [[ref: KERI event stream]] MAY provide mechanisms for detecting such behavior, such
as KERI witnesses and watchers.

### Handling Web Redirection

A `did:webs` is intended to be a "stable" (long-lasting) identifier that can be
put into documents such as verifiable credentials, and that are intended to be
useful for a very long time -- generations. However, the web is not a very
stable place, and documents are moved around and copied frequently. When two or
more companies merge, often the web presence of some of the merged entities
"disappears". It may not be possible to retain a permanent `did:webs` web
location.

When a `did:webs` is updated for another location, its AID does not change. The same [[ref: KERI event stream]] is used to verify
the DID document. Were the AID to change, it would be an altogether new DID,
unconnected to the first DID. So if a resolver can find a newly named DID that
uses the same AID, and the [[ref: KERI event stream]] verifies the DID, then they have resolved the
DID. In fact, a `did:webs` could be moved to use another DID method that uses
the AID for uniqueness and the [[ref: KERI event stream]] for validity, but that is beyond the scope of this specification.

The following are the capabilities in `did:webs` to help in the face of
resolution uncertainty.

- The `did:webs` is bound to other [[ref: Authorized Identifiers]] that are anchored to the [[ref: KERI event stream]], and
  as the `id` in the DID document.
- When a `did:webs` is permanently moved to some other location the resolver can redirect to any other Authorized Identifier.
  - The `id` in the DID document is set to the new location.
  - An `equivalentId` entry of the old location will be revoked an anchored to the [[ref: KERI event stream]].
  - If possible, the controller of the DID MAY use web redirects to allow
    resolution of the old location of the DID to the new location.

The purpose of the history of "official" (according to the controller) locations
for the DID documents is so that if the DID has been put in long-lasting documents,
and its URL instantiation is redirected or disappears, the controller can
explicitly indicate that the new DID is an `equivalentId`` to the old one.

If the previously published location of a `did:webs` is not redirected, an
entity trying to resolve the DID MAY be able to find the data for the DID
somewhere else using just the AID. Since the AID is globally unique and
references the same identifier, regardless of the rest of the string that is the
full `did:webs`, web searching could yield either the current location of the
DID document, or a copy of the DID that may be useful. For example, even the [Internet
Archive: Wayback Machine](https://archive.org/web) could be used to find a copy
of the DID document and the [[ref: KERI event stream]] at some point in the past that may be sufficient for the
purposes of the entity trying to resolve the DID. This specification does not
rely on the Wayback Machine, but it might be a useful `did:webs` discovery tool.

The DID document, [[ref: KERI event stream]] and other files related to a DID may be copied to other web
locations. For example, someone might want to keep a cache of DIDs they use, or
an entity might want to run a registry of "useful" DIDs for a cooperating group.
While the combination of DID document and [[ref: KERI event stream]] make the DID and DID document verifiable, just
as when published in their "intended" location, the absence of the `did:webs` in the [[ref: Authorized Identifiers]] for those locations
in the DID document `equivalentId` means that the controller of the DID is
not self-asserting any sort of tie between the DID and the location to which the
DID-related documents have been copied. In contrast, if the controller confirms the link between the source and the copy with an `equivalentId`, the related copies will have to be looked after.

### DID Method Operations

#### Create

Creating a `did:webs` DID involves the following steps:

1. Choose the web URL where the DID document for the DID will be published, excluding
   the last element that will be the AID, once defined.
2. Create a KERI AID and add it as the last element of the web URL for the DID.
3. Add the appropriate KERI events to the AID's KERI logs that will correspond to properties of the DID document, such as verification methods and service endpoints.
4. Derive the `did:webs` [[ref: DID document]] by processing the [[ref: KERI event stream]]
   according to section [DID Document from KERI Events](#did-document-from-keri-events).
5. For compatibility reasons, transform the derived `did:webs` DID document to the corresponding `did:web` DID document according to section [Transformation to did:web DID Document](#transformation-to-didweb-did-document).
6. Create the AID folder on the web server at the selected location, and place
   the `did:web` DID document resource (`did.json`) and the [[ref: KERI event stream]] resource (`keri.cesr`)
   into that folder. See section [Target System(s)](#target-systems) for further details about
   the locations of these resources.

Of course, the web server that serves the resources when asked might be a simple
file server (as implied above) or an active component that generates them
dynamically. Further, the publisher of the resources placed on the web can use
capabilities like [CDNs] to distribute the resources. How the resources are posted at the required location is not defined by this spec; complying implementations need not support any HTTP methods other than GET.

Likewise, an active component might be used by the controller of the DID to
automate the process of publishing and updating the DID document and [[ref: KERI event stream]] resources.

#### Read (Resolve)

Resolving a `did:webs` DID involves the following steps:

1. Convert the `did:webs` DID back to HTTPS URLs as described in section [Target System(s)](#target-systems).
2. Execute HTTP GET requests on both the URL for the DID document (ending in `/did.json`)
and the URL for the [[ref: KERI event stream]] (ending in `/keri.cesr`).
3. Process the [[ref: KERI event stream]] using [KERI Rules] to verify it, then derive the `did:webs`
   [[ref: DID document]] by processing the [[ref: KERI event stream]]
   according to section [DID Document from KERI Events](#did-document-from-keri-events).
4. Transform the retrieved `did:web` DID document to the corresponding `did:webs` DID document according
   to section [Transformation to did:webs DID Document](#transformation-to-didwebs-did-document).
5. Verify that the derived `did:webs` DID document (from step 3) equals the transformed DID document (from step 4).

Further, KERI-aware applications
MAY use the [[ref: KERI event stream]] to make use of additional capabilities enabled by the use of
KERI. Capabilities beyond the verification of the DID document and [[ref: KERI event stream]] are outside
the scope of this specification.

#### Update

If an AID is updatable, updates are made to the AID by adding KERI events to
the [[ref: KERI event stream]]. Some of those events may cause the DID document to be updated. Once
a set of events have been applied, derive the DID document from the [[ref: KERI event stream]] and republish
both documents to the web server, overwriting the existing files.

#### Deactivate

Execute a KERI event that has the effect of rotating the key(s) to null. Once
the deactivation events have been applied, derive the DID document from the [[ref: KERI event stream]] and
republish both documents to the web server, overwriting the existing files.

A controller may choose to simply remove the DID folder and files from the web
server on which it has been published. This is considered to a bad approach, as
those resolving the DID will not be able to determine if the web service is
offline or the DID has been deactivated. It is a much better practice to rotate
the keys to null and continuing to publish the DID document and [[ref: KERI event stream]].
